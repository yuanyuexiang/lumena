<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumena æˆ¿é—´åˆ›å»ºè€…</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <!-- ä½¿ç”¨æ›´å¯é çš„äºŒç»´ç åº“ -->
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <style>
      /* æ·»åŠ äºŒç»´ç ç›¸å…³æ ·å¼ */
      .qrcode-container {
        text-align: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin: 15px 0;
      }
      
      .qrcode-container #qrcode {
        border: 3px solid white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        background: white;
        padding: 10px;
      }
      
      .qrcode-info {
        margin-top: 10px;
        color: #333;
        font-size: 14px;
      }
      
      .room-info {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
        text-align: center;
      }
      
      .room-info h2 {
        font-size: 24px;
        margin-bottom: 10px;
      }
      
      .room-id {
        font-size: 32px;
        font-weight: bold;
        letter-spacing: 2px;
        margin: 10px 0;
        font-family: 'Courier New', monospace;
      }
      
      .scan-instruction {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        backdrop-filter: blur(10px);
      }
      
      .scan-instruction h3 {
        color: #333;
        margin-bottom: 10px;
      }
      
      .scan-steps {
        text-align: left;
        color: #555;
      }
      
      .scan-steps li {
        margin: 5px 0;
        padding: 5px 0;
      }
      
      .mobile-link {
        background: #667eea;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-block;
        margin: 10px 0;
        font-weight: bold;
      }
      
      .mobile-link:hover {
        background: #5a6fd8;
      }

      /* æ·»åŠ åŸºæœ¬æ ·å¼ */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      .btn.success {
        background: #4CAF50;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .button-group {
        margin: 10px 0;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      .status-item:last-child {
        border-bottom: none;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .video-placeholder {
        padding: 40px;
        text-align: center;
        color: #666;
        background: #f0f0f0;
      }

      .connection-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }

      .connection-indicator.connected {
        background: #4CAF50;
      }

      .connection-indicator.disconnected {
        background: #f44336;
      }

      .logs {
        max-height: 300px;
        overflow-y: auto;
        background: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
      }

      .result-box {
        margin: 10px 0;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 5px;
        min-height: 50px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¥ Lumena æˆ¿é—´åˆ›å»ºè€…</h1>
      
      <!-- æˆ¿é—´ç®¡ç†åŒºåŸŸ -->
      <div class="section">
        <h3>ğŸ  æˆ¿é—´ç®¡ç†</h3>
        <div class="button-group">
          <button id="createRoomBtn" class="btn success">ğŸ†• åˆ›å»ºæ–°æˆ¿é—´</button>
          <button id="shareRoomBtn" class="btn">ğŸ“¤ åˆ†äº«æˆ¿é—´</button>
        </div>
        <div class="status-item">
          <span class="status-label">è¿æ¥çŠ¶æ€:</span>
          <span class="status-value" id="connectionStatus">æœªè¿æ¥</span>
        </div>
      </div>
      
      <!-- æˆ¿é—´ä¿¡æ¯å’ŒäºŒç»´ç åŒºåŸŸ -->
      <div class="section" id="roomInfoSection" style="display: none;">
        <div class="room-info">
          <h2>ğŸ  æˆ¿é—´å·²åˆ›å»º</h2>
          <div class="room-id" id="currentRoom">-</div>
          <p>æ‰«æä¸‹æ–¹äºŒç»´ç æˆ–ç‚¹å‡»é“¾æ¥åŠ å…¥æˆ¿é—´</p>
        </div>
        
        <div class="qrcode-container">
          <div id="qrcode"></div>
          <div class="qrcode-info">
            <p>ğŸ“± ä½¿ç”¨æ‰‹æœºæ‰«æäºŒç»´ç åŠ å…¥æˆ¿é—´</p>
          </div>
        </div>
        
        <div class="scan-instruction">
          <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
          <ol class="scan-steps">
            <li>ğŸ“± æ‰“å¼€æ‰‹æœºæ‘„åƒå¤´æˆ–æ‰«ç åº”ç”¨</li>
            <li>ğŸ¯ æ‰«æä¸Šæ–¹äºŒç»´ç </li>
            <li>ğŸš€ è‡ªåŠ¨æ‰“å¼€æˆ¿é—´é¡µé¢</li>
            <li>ğŸ“· ç‚¹å‡»"å¼€å§‹è§†é¢‘"å³å¯å¼€å§‹é€šè¯</li>
          </ol>
        </div>
        
        <div style="text-align: center;">
          <a href="#" id="mobileLink" class="mobile-link" target="_blank">
            ğŸ“± ç›´æ¥åœ¨æ‰‹æœºä¸Šæ‰“å¼€
          </a>
        </div>
      </div>
      
      <div class="grid-2">
        <div>
          <!-- ç½‘ç»œè¯Šæ–­åŒºåŸŸ -->
          <div class="section">
            <h3>ğŸ”§ ç½‘ç»œè¯Šæ–­</h3>
            <div class="button-group">
              <button id="testTurnBtn" class="btn">æµ‹è¯• TURN æœåŠ¡å™¨</button>
              <button id="diagnosisBtn" class="btn">ç½‘ç»œè¯Šæ–­</button>
            </div>
            <div id="turnTestResult" class="result-box"></div>
            <div id="diagnosisResult" class="result-box"></div>
          </div>

          <!-- è¿æ¥çŠ¶æ€ -->
          <div class="section">
            <h3>ğŸ“¡ è¿æ¥çŠ¶æ€</h3>
            <div class="status-box">
              <div class="status-item">
                <span class="status-label">è¿æ¥æ–¹å¼:</span>
                <span class="status-value">
                  <span class="connection-indicator disconnected"></span>
                  <span id="connectionType">æœªè¿æ¥</span>
                </span>
              </div>
              <div class="status-item">
                <span class="status-label">è¿œç¨‹ç”¨æˆ·:</span>
                <span class="status-value" id="remoteUsers">0</span>
              </div>
              <div class="status-item">
                <span class="status-label">ç½‘ç»œå»¶è¿Ÿ:</span>
                <span class="status-value" id="networkDelay">-</span>
              </div>
            </div>
          </div>
        </div>

        <div>
          <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
          <div class="section">
            <h3>ğŸ¬ è¿œç¨‹è§†é¢‘æµ</h3>
            <div class="video-container">
              <div class="video-box">
                <h4>è¿œç¨‹ç”¨æˆ·è§†é¢‘</h4>
                <div id="remoteVideos">
                  <video id="remoteVideo" width="400" height="300" autoplay></video>
                </div>
                <div class="video-placeholder" id="videoPlaceholder">
                  <p>ğŸ“± ç­‰å¾…æ‰‹æœºç”¨æˆ·æ‰«ç è¿æ¥...</p>
                  <p>è¯·ä½¿ç”¨æ‰‹æœºæ‰«æäºŒç»´ç åŠ å…¥æˆ¿é—´</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ—¥å¿—åŒºåŸŸ -->
      <div class="section">
        <h3>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h3>
        <div id="logs" class="logs"></div>
      </div>
    </div>
  </body>

  <script>
    let peer_connection;
    let mqttClient;
    let roomId = null;
    let localPeerId = 'host-' + Math.random().toString(36).substr(2, 9);
    let connectionStatsInterval;
    let connectedUsers = 0;

    // ç”ŸæˆäºŒç»´ç  - ä½¿ç”¨ qrcode-generator åº“
    function generateQRCode(url) {
      const qrContainer = document.getElementById('qrcode');
      
      try {
        // åˆ›å»ºäºŒç»´ç 
        const qr = qrcode(0, 'M');
        qr.addData(url);
        qr.make();
        
        // ç”ŸæˆHTML
        const qrHTML = qr.createImgTag(4, 8);
        qrContainer.innerHTML = qrHTML;
        
        console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸ');
      } catch (error) {
        console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
        // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºé“¾æ¥
        qrContainer.innerHTML = `
          <div style="padding: 20px; background: white; border-radius: 10px;">
            <p>äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç›´æ¥å¤åˆ¶é“¾æ¥:</p>
            <input type="text" value="${url}" readonly style="width: 100%; padding: 10px; margin: 10px 0;">
          </div>
        `;
      }
    }

    // åˆå§‹åŒ– MQTT è¿æ¥
    function initializeMQTT() {
      const brokerUrl = 'wss://meteor.matrix-net.tech/mqtt';
      
      console.log('Connecting to EMQX MQTT broker:', brokerUrl);
      
      mqttClient = mqtt.connect(brokerUrl, {
        clientId: localPeerId,
        clean: true,
        connectTimeout: 4000,
        username: 'matrix',
        password: 'sual116y',
        reconnectPeriod: 1000,
        protocolVersion: 4,
        keepalive: 60,
      });

      mqttClient.on('connect', function () {
        console.log('âœ… EMQX MQTT Connected successfully');
        document.getElementById('connectionStatus').textContent = 'MQTTå·²è¿æ¥';
        
        if (roomId) {
          // è®¢é˜…æˆ¿é—´ä¸»é¢˜
          mqttClient.subscribe(`webrtc/${roomId}/+/+`, function (err) {
            if (!err) {
              console.log(`ğŸ“¡ Subscribed to room: ${roomId}`);
              
              // å‘é€æˆ¿é—´åˆ›å»ºæ¶ˆæ¯
              mqttClient.publish(`webrtc/${roomId}/${localPeerId}/room-created`, JSON.stringify({
                type: 'room-created',
                hostId: localPeerId,
                timestamp: Date.now()
              }));
              
              const logDiv = document.getElementById('logs');
              const timestamp = new Date().toLocaleTimeString();
              logDiv.innerHTML += `<p style="color: #51cf66;">[${timestamp}] ğŸ  æˆ¿é—´å·²åˆ›å»º: ${roomId}</p>`;
              logDiv.scrollTop = logDiv.scrollHeight;
            }
          });
        }
      });

      mqttClient.on('message', function (topic, message) {
        const topicParts = topic.split('/');
        const remotePeerId = topicParts[2];
        const messageType = topicParts[3];
        
        if (remotePeerId === localPeerId) return;
        
        try {
          const data = JSON.parse(message.toString());
          console.log('ğŸ“¥ MQTT message received:', { topic, messageType, data });
          
          const logDiv = document.getElementById('logs');
          const timestamp = new Date().toLocaleTimeString();
          logDiv.innerHTML += `<p style="color: #74c0fc;">[${timestamp}] ğŸ“¨ æ”¶åˆ°${messageType}æ¶ˆæ¯</p>`;
          logDiv.scrollTop = logDiv.scrollHeight;
          
          handleSignalingMessage(messageType, data, remotePeerId);
        } catch (error) {
          console.error('âŒ Error parsing MQTT message:', error);
        }
      });

      mqttClient.on('error', function (error) {
        console.error('âŒ EMQX MQTT Error:', error);
        document.getElementById('connectionStatus').textContent = 'MQTTè¿æ¥å¤±è´¥';
        
        const logDiv = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `<p style="color: #ff6b6b;">[${timestamp}] âŒ MQTTè¿æ¥å¤±è´¥: ${error.message}</p>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      });

      mqttClient.on('reconnect', function () {
        console.log('ğŸ”„ EMQX MQTT Reconnecting...');
        document.getElementById('connectionStatus').textContent = 'MQTTé‡è¿ä¸­...';
      });
    }

    // å¤„ç†ä¿¡ä»¤æ¶ˆæ¯
    function handleSignalingMessage(messageType, data, remotePeerId) {
      switch (messageType) {
        case 'join-room':
          console.log(`ğŸ‘‹ User ${remotePeerId} wants to join room`);
          connectedUsers++;
          document.getElementById('remoteUsers').textContent = connectedUsers;
          
          // æ›´æ–°å ä½ç¬¦æ–‡æœ¬
          const placeholder = document.getElementById('videoPlaceholder');
          placeholder.innerHTML = `
            <p>ğŸ“± æ‰‹æœºç”¨æˆ·å·²è¿æ¥</p>
            <p>æ­£åœ¨ç­‰å¾…è§†é¢‘æµ...</p>
          `;
          
          // æå‰åˆå§‹åŒ–WebRTCè¿æ¥ï¼Œå‡†å¤‡æ¥æ”¶offer
          if (!peer_connection) {
            initializeWebRTC();
          }
          
          // å‘é€ç¡®è®¤æ¶ˆæ¯ç»™æ‰‹æœºç«¯
          sendSignalingMessage('room-ready', {
            type: 'room-ready',
            hostId: localPeerId,
            timestamp: Date.now()
          });
          
          const logDiv = document.getElementById('logs');
          const timestamp = new Date().toLocaleTimeString();
          logDiv.innerHTML += `<p style="color: #51cf66;">[${timestamp}] ğŸ“± æ‰‹æœºç”¨æˆ·å·²è¿æ¥ï¼Œå‡†å¤‡æ¥æ”¶è§†é¢‘æµ</p>`;
          logDiv.scrollTop = logDiv.scrollHeight;
          break;
          
        case 'offer':
          console.log("ğŸ“ Received offer from", remotePeerId);
          // æ”¶åˆ°offeræ—¶æ˜¾ç¤ºè§†é¢‘åŒºåŸŸ
          document.getElementById('videoPlaceholder').style.display = 'none';
          document.getElementById('remoteVideo').style.display = 'block';
          handleOffer(data, remotePeerId);
          break;
          
        case 'answer':
          console.log("âœ… Received answer from", remotePeerId);
          handleAnswer(data);
          break;
          
        case 'candidate':
          console.log("ğŸ¯ Received ICE candidate from", remotePeerId);
          handleIceCandidate(data);
          break;
      }
    }

    // åˆå§‹åŒ–WebRTCè¿æ¥ï¼ˆæ¥æ”¶ç«¯ï¼‰
    function initializeWebRTC() {
      if (peer_connection) {
        console.log('WebRTC connection already exists');
        return;
      }
      
      const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:coturn.meteor.matrix-net.tech:3478' },
        {
          urls: 'turn:coturn.meteor.matrix-net.tech:3478?transport=tcp',
          username: 'matrix',
          credential: 'sual116y'
        },
        {
          urls: 'turn:coturn.meteor.matrix-net.tech:3478?transport=udp',
          username: 'matrix',
          credential: 'sual116y'
        }
      ];

      peer_connection = new RTCPeerConnection({
        iceServers,
        iceTransportPolicy: 'all'
      });

      // å¤„ç†è¿œç¨‹æµ
      peer_connection.ontrack = (event) => {
        console.log('ğŸ¥ Remote stream received');
        const remoteVideo = document.getElementById('remoteVideo');
        
        if (event.streams && event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          
          // ç¡®ä¿è§†é¢‘å…ƒç´ å¯è§
          remoteVideo.style.display = 'block';
          document.getElementById('videoPlaceholder').style.display = 'none';
          
          const logDiv = document.getElementById('logs');
          const timestamp = new Date().toLocaleTimeString();
          logDiv.innerHTML += `<p style="color: #51cf66;">[${timestamp}] ğŸ¥ æ‰‹æœºè§†é¢‘æµå·²è¿æ¥</p>`;
          logDiv.scrollTop = logDiv.scrollHeight;
        } else {
          console.error('No streams found in track event');
        }
      };

      // å¤„ç† ICE candidate
      peer_connection.onicecandidate = e => {
        if (!e.candidate) {
          console.log('â„ï¸ ICE gathering complete');
          return;
        }
        
        console.log('ğŸ¯ ICE Candidate:', {
          type: e.candidate.type,
          protocol: e.candidate.protocol,
          address: e.candidate.address
        });
        sendSignalingMessage('candidate', e.candidate);
      };

      // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
      peer_connection.onconnectionstatechange = () => {
        console.log('ğŸ”— Connection state:', peer_connection.connectionState);
        
        const logDiv = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        
        switch (peer_connection.connectionState) {
          case 'connected':
            logDiv.innerHTML += `<p style="color: #51cf66;">[${timestamp}] ğŸ‰ ä¸æ‰‹æœºçš„P2Pè¿æ¥å·²å»ºç«‹ï¼</p>`;
            document.getElementById('connectionType').textContent = 'å·²è¿æ¥';
            document.querySelector('.connection-indicator').className = 'connection-indicator connected';
            startConnectionMonitoring();
            break;
          case 'connecting':
            logDiv.innerHTML += `<p style="color: #ffd43b;">[${timestamp}] ğŸ”„ æ­£åœ¨ä¸æ‰‹æœºå»ºç«‹P2Pè¿æ¥...</p>`;
            document.getElementById('connectionType').textContent = 'è¿æ¥ä¸­';
            document.querySelector('.connection-indicator').className = 'connection-indicator connecting';
            break;
          case 'disconnected':
            logDiv.innerHTML += `<p style="color: #ffd43b;">[${timestamp}] ğŸ”Œ ä¸æ‰‹æœºçš„P2Pè¿æ¥å·²æ–­å¼€</p>`;
            document.getElementById('connectionType').textContent = 'å·²æ–­å¼€';
            document.querySelector('.connection-indicator').className = 'connection-indicator disconnected';
            break;
          case 'failed':
            logDiv.innerHTML += `<p style="color: #ff6b6b;">[${timestamp}] âŒä¸æ‰‹æœºçš„P2Pè¿æ¥å¤±è´¥</p>`;
            document.getElementById('connectionType').textContent = 'è¿æ¥å¤±è´¥';
            document.querySelector('.connection-indicator').className = 'connection-indicator disconnected';
            break;
        }
        logDiv.scrollTop = logDiv.scrollHeight;
      };

      console.log('âœ… WebRTC connection initialized (receiver)');
    }

    // å‘é€ä¿¡ä»¤æ¶ˆæ¯
    function sendSignalingMessage(messageType, data) {
      const topic = `webrtc/${roomId}/${localPeerId}/${messageType}`;
      const message = JSON.stringify(data);
      
      mqttClient.publish(topic, message, { qos: 0 }, function(err) {
        if (err) {
          console.error('âŒ Failed to send MQTT message:', err);
        } else {
          console.log(`ğŸ“¤ Sent ${messageType} message via MQTT`);
        }
      });
    }

    // å¤„ç† offer
    function handleOffer(offer, remotePeerId) {
      if (!peer_connection) {
        console.error('âŒ No peer connection when handling offer');
        return;
      }
      
      const logDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<p style="color: #74c0fc;">[${timestamp}] ğŸ“ æ”¶åˆ°æ‰‹æœºè¿æ¥è¯·æ±‚ï¼Œæ­£åœ¨å“åº”...</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      
      peer_connection.setRemoteDescription(new RTCSessionDescription(offer)).then(() => {
        console.log('âœ… Remote description set successfully');
        return peer_connection.createAnswer();
      }).then(answer => {
        console.log('âœ… Answer created successfully');
        return peer_connection.setLocalDescription(answer);
      }).then(() => {
        console.log('âœ… Local description set successfully');
        sendSignalingMessage('answer', peer_connection.localDescription);
        
        logDiv.innerHTML += `<p style="color: #74c0fc;">[${timestamp}] ğŸ“¤ å·²å‘é€è¿æ¥å“åº”ç»™æ‰‹æœº</p>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }).catch(error => {
        console.error('âŒ Error handling offer:', error);
        logDiv.innerHTML += `<p style="color: #ff6b6b;">[${timestamp}] âŒ å¤„ç†è¿æ¥è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      });
    }

    // å¤„ç† answer
    function handleAnswer(answer) {
      if (!peer_connection) {
        console.error('âŒ No peer connection when handling answer');
        return;
      }
      
      peer_connection.setRemoteDescription(new RTCSessionDescription(answer)).then(() => {
        console.log('âœ… Remote description set from answer');
      }).catch(error => {
        console.error('âŒ Error handling answer:', error);
      });
    }

    // å¤„ç† ICE candidate
    function handleIceCandidate(candidate) {
      if (!peer_connection) {
        console.error('âŒ No peer connection when handling ICE candidate');
        return;
      }
      
      peer_connection.addIceCandidate(new RTCIceCandidate(candidate)).then(() => {
        console.log('âœ… ICE candidate added successfully');
      }).catch(error => {
        console.error('âŒ Error adding ICE candidate:', error);
      });
    }

    // å¼€å§‹è¿æ¥ç›‘æ§
    function startConnectionMonitoring() {
      if (connectionStatsInterval) {
        clearInterval(connectionStatsInterval);
      }
      
      connectionStatsInterval = setInterval(async () => {
        try {
          const stats = await peer_connection.getStats();
          stats.forEach(report => {
            if (report.type === 'candidate-pair' && report.state === 'succeeded') {
              if (report.currentRoundTripTime) {
                const rtt = Math.round(report.currentRoundTripTime * 1000);
                document.getElementById('networkDelay').textContent = `${rtt} ms`;
                
                const delayElement = document.getElementById('networkDelay');
                if (rtt < 50) {
                  delayElement.style.color = '#51cf66';
                } else if (rtt < 150) {
                  delayElement.style.color = '#ffd43b';
                } else {
                  delayElement.style.color = '#ff6b6b';
                }
              }
            }
          });
        } catch (error) {
          console.error('è·å–è¿æ¥ç»Ÿè®¡å¤±è´¥:', error);
        }
      }, 2000);
    }

    // åˆ›å»ºæˆ¿é—´
    function createRoom() {
      roomId = 'room-' + Math.random().toString(36).substr(2, 9);
      document.getElementById('currentRoom').textContent = roomId;
      
      // ç”Ÿæˆæ‰‹æœºç«¯é“¾æ¥
      const mobileLink = `${window.location.origin}/room-join-mobile.html?room=${roomId}`;
      document.getElementById('mobileLink').href = mobileLink;
      
      // ç”ŸæˆäºŒç»´ç 
      generateQRCode(mobileLink);
      
      // æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯åŒºåŸŸ
      document.getElementById('roomInfoSection').style.display = 'block';
      
      // è¿æ¥MQTT
      initializeMQTT();
      
      const logDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<p style="color: #51cf66;">[${timestamp}] ğŸ  æˆ¿é—´å·²åˆ›å»º: ${roomId}</p>`;
      logDiv.innerHTML += `<p style="color: #51cf66;">[${timestamp}] ğŸ“± è¯·ä½¿ç”¨æ‰‹æœºæ‰«æäºŒç»´ç åŠ å…¥æˆ¿é—´</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // åˆ†äº«æˆ¿é—´
    function shareRoom() {
      if (!roomId) {
        alert('è¯·å…ˆåˆ›å»ºæˆ¿é—´ï¼');
        return;
      }
      
      const mobileLink = document.getElementById('mobileLink').href;
      
      if (navigator.share) {
        navigator.share({
          title: 'Lumena è§†é¢‘é€šè¯',
          text: `åŠ å…¥æˆ‘çš„è§†é¢‘é€šè¯æˆ¿é—´: ${roomId}`,
          url: mobileLink
        }).catch(console.error);
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(mobileLink).then(() => {
          alert('æˆ¿é—´é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + mobileLink);
        }).catch(() => {
          prompt('å¤åˆ¶æ­¤é“¾æ¥åˆ†äº«ç»™å…¶ä»–äºº:', mobileLink);
        });
      } else {
        prompt('å¤åˆ¶æ­¤é“¾æ¥åˆ†äº«ç»™å…¶ä»–äºº:', mobileLink);
      }
    }

    // æµ‹è¯• TURN æœåŠ¡å™¨
    async function testTurnServer() {
      const resultDiv = document.getElementById('turnTestResult');
      resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯• TURN æœåŠ¡å™¨è¿é€šæ€§...</p>';
      
      try {
        const testPC = new RTCPeerConnection({
          iceServers: [
            {
              urls: 'turn:coturn.meteor.matrix-net.tech:3478?transport=tcp',
              username: 'matrix',
              credential: 'sual116y'
            }
          ],
          iceTransportPolicy: 'relay'
        });

        let turnCandidateFound = false;
        
        testPC.onicecandidate = (event) => {
          if (event.candidate && event.candidate.type === 'relay') {
            turnCandidateFound = true;
            resultDiv.innerHTML = '<p style="color: green;">âœ“ TURN æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼</p>';
          }
        };

        testPC.createDataChannel('test');
        const offer = await testPC.createOffer();
        await testPC.setLocalDescription(offer);

        setTimeout(() => {
          if (!turnCandidateFound) {
            resultDiv.innerHTML = '<p style="color: red;">âœ— TURN æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼</p>';
          }
          testPC.close();
        }, 5000);

      } catch (error) {
        resultDiv.innerHTML = `<p style="color: red;">æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
      }
    }

    // ç½‘ç»œè¯Šæ–­
    async function runNetworkDiagnosis() {
      const resultDiv = document.getElementById('diagnosisResult');
      resultDiv.innerHTML = '<p>æ­£åœ¨è¿›è¡Œç½‘ç»œè¯Šæ–­...</p>';
      
      try {
        const testPC = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            {
              urls: 'turn:coturn.meteor.matrix-net.tech:3478?transport=tcp',
              username: 'matrix',
              credential: 'sual116y'
            }
          ]
        });

        const results = {
          host: false,
          srflx: false,
          relay: false
        };

        testPC.onicecandidate = (event) => {
          if (event.candidate) {
            const type = event.candidate.type;
            if (type === 'host') results.host = true;
            if (type === 'srflx') results.srflx = true;
            if (type === 'relay') results.relay = true;
          }
        };

        testPC.createDataChannel('test');
        const offer = await testPC.createOffer();
        await testPC.setLocalDescription(offer);

        setTimeout(() => {
          let report = '<div style="border: 1px solid #ccc; padding: 10px;">';
          report += '<h4>ğŸ“Š ç½‘ç»œè¯Šæ–­æŠ¥å‘Š</h4>';
          report += '<p><strong>ICE Candidate æ”¯æŒ:</strong></p><ul>';
          report += `<li>Host (æœ¬åœ°): ${results.host ? 'âœ“' : 'âœ—'}</li>`;
          report += `<li>Server Reflexive (STUN): ${results.srflx ? 'âœ“' : 'âœ—'}</li>`;
          report += `<li>Relay (TURN): ${results.relay ? 'âœ“' : 'âœ—'}</li>`;
          report += '</ul>';
          
          if (results.relay) {
            report += '<p style="color: green;">âœ“ ç½‘ç»œç¯å¢ƒè‰¯å¥½ï¼Œæ”¯æŒè·¨ç½‘ç»œè¿æ¥</p>';
          } else {
            report += '<p style="color: red;">âš  å¯èƒ½æ— æ³•å»ºç«‹è·¨ç½‘ç»œè¿æ¥</p>';
          }
          
          report += '</div>';
          resultDiv.innerHTML = report;
          testPC.close();
        }, 3000);

      } catch (error) {
        resultDiv.innerHTML = `<p style="color: red;">è¯Šæ–­å¤±è´¥: ${error.message}</p>`;
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('createRoomBtn').addEventListener('click', createRoom);
      document.getElementById('shareRoomBtn').addEventListener('click', shareRoom);
      document.getElementById('testTurnBtn').addEventListener('click', testTurnServer);
      document.getElementById('diagnosisBtn').addEventListener('click', runNetworkDiagnosis);
      
      // åˆå§‹éšè—è¿œç¨‹è§†é¢‘
      document.getElementById('remoteVideo').style.display = 'none';
    });
  </script>
</html>